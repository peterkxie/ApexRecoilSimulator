<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apex Recoil Simulator</title>
</head>
<body>

<!-- Recoil patterns -->
<script>
    let patterns = {
        "R-301": [
            [0, 10],
            [3, 5]
        ]
    }
</script>

<canvas id="myCanvas" width="400" height="500" style="border: 1px solid black;"></canvas>
<div id="recoilPatternCreationPanel">
    <button id="createRecoilPatternButton" onclick="createRecoilPattern()">Create Recoil Pattern</button>
    <button id="undoRecoilPatternButton" onclick="undoRecoilPatternMove()" disabled>Undo</button>
    <button id="finishRecoilPatternButton" onclick="finishRecoilPattern()" disabled>Done</button>
    <button id="cancelRecoilPatternButton" onclick="cancelRecoilPattern()" disabled>Cancel</button>
</div>
<div id="presetRecoilPatternsDiv">
    <p>Light Guns</p>
    <button onclick="displayPresetRecoilPattern('R-301')">R-301</button>
    <button onclick="displayPresetRecoilPattern('R-99')">R-99</button>
</div>
<div id="outputDiv">
    <p id="output"></p>
</div>
<div id="debug">
    <p id="debugOutput"></p>
</div>

<script>
    let canvasElement = document.getElementById("myCanvas");
    let context = canvasElement.getContext("2d");

    let dotSize = 3;

    // Global state variables
    let editMode = false;

    function getCanvas() {
        return canvasElement;
    }
    function getCanvasContext() {
        return context;
    }

    function clearCanvas() {
        getCanvasContext().clearRect(0, 0, getCanvas().width, getCanvas().height);
    }

    function drawRecoilPattern(recoilPatternArray, shouldLockAndClearCanvas = true) {
        if (shouldLockAndClearCanvas) {
            editMode = false;
            clearCanvas();
            enableRecoilPatternButtons(true, false, false, false);
        }

        let coordinate = [0, 0];
        drawDotC(htoc(coordinate[0], coordinate[1]));
        recoilPatternArray.forEach(value => {
            coordinate[0] = coordinate[0] + value[0];
            coordinate[1] = coordinate[1] + value[1];
            drawDotC(htoc(coordinate[0], coordinate[1]))
        });
    }

    function drawDotC(coordinate) {
        getCanvasContext().fillRect(coordinate[0], coordinate[1], dotSize, dotSize);
    }

    function drawDotH(coordinate) {
        let cCoord = htoc(coordinate[0], coordinate[1]);
        getCanvasContext().fillRect(cCoord[0], cCoord[1], dotSize, dotSize);
    }

    function eraseDotC(coordinate) {
        getCanvasContext().fillRect(coordinate[0], coordinate[1], dotSize, dotSize);
    }

    function eraseDotH(coordinate) {
        let cCoord = htoc(coordinate[0], coordinate[1]);
        getCanvasContext().fillRect(cCoord[0], cCoord[1], dotSize, dotSize);
    }

    // Convert human coordinate to canvas coordinate
    // Coordinate system is x axis along the bottom, y axis in the middle
    // htoc = human to canvas
    function htoc(x, y) {
        return [
            x + getCanvas().width / 2,
            getCanvas().height - y - 40
        ];
    }

    // ctoh = canvas to human
    function ctoh(x, y) {
        return [
            x - getCanvas().width / 2,
            getCanvas().height - y - 40
        ];
    }

    getCanvas().addEventListener("mousedown", event => {
        let rect = getCanvas().getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;
    });

    ////////////////// Recoil pattern creation //////////////////

    let recoilPattern = [];
    let coordTracker = [0, 0];

    function enableRecoilPatternButtons(create, undo, done, cancel) {
        document.getElementById("createRecoilPatternButton").disabled = !create;
        document.getElementById("undoRecoilPatternButton").disabled = !undo;
        document.getElementById("finishRecoilPatternButton").disabled = !done;
        document.getElementById("cancelRecoilPatternButton").disabled = !cancel;
    }

    function createRecoilPattern() {
        editMode = true;
        clearCanvas();
        drawDotC(htoc(0, 0));
        coordTracker = [0, 0];
        recoilPattern.length = 0;
        enableRecoilPatternButtons(false, true, true, true);
    }

    function undoRecoilPatternMove() {
        recoilPattern.pop();

        // Redraw full canvas because i'm too lazy to figure out how to undo
        clearCanvas();

        drawRecoilPattern(recoilPattern, false);
    }

    function finishRecoilPattern() {
        editMode = false;

        let saveText = JSON.stringify(recoilPattern);
        copyTextToClipboard(saveText);

        let outputText = "Finished your recoil pattern! The following has been copied to your clipboard:";
        recoilPattern.forEach(value => {
            outputText += '\n' + value;
        });
        document.getElementById("output").innerText = outputText;
    }

    function cancelRecoilPattern() {
        editMode = false;
        clearCanvas();
        enableRecoilPatternButtons(true, false, false, false);
    }

    getCanvas().addEventListener("mousedown", event => {
        if (!editMode) { return; }

        let rect = getCanvas().getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;
        let newCoord = ctoh(x, y);

        recoilPattern.push([newCoord[0] - coordTracker[0], newCoord[1] - coordTracker[1]]);
        coordTracker[0] = newCoord[0];
        coordTracker[1] = newCoord[1];
        drawDotH(coordTracker);
        document.getElementById("debugOutput").innerText = recoilPattern;
    });

    ////////////////// Preset recoil patterns //////////////////

    let presetRecoilPatterns = {
        "R-301": [[0,24],[7,30],[-5,33],[-5,34],[2,22],[11,33],[6,21]]
    }

    function displayPresetRecoilPattern(gunName) {
        drawRecoilPattern(presetRecoilPatterns[gunName]);
    }
</script>

<script>
    // Random copied stuff
    function copyTextToClipboard(text) {
        var textArea = document.createElement("textarea");

        // Place in the top-left corner of screen regardless of scroll position.
        textArea.style.position = 'fixed';
        textArea.style.top = 0;
        textArea.style.left = 0;

        // Ensure it has a small width and height. Setting to 1px / 1em
        // doesn't work as this gives a negative w/h on some browsers.
        textArea.style.width = '2em';
        textArea.style.height = '2em';

        // We don't need padding, reducing the size if it does flash render.
        textArea.style.padding = 0;

        // Clean up any borders.
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';

        // Avoid flash of the white box if rendered for any reason.
        textArea.style.background = 'transparent';


        textArea.value = text;

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'successful' : 'unsuccessful';
        } catch (err) {
            document.getElementById("debugOutput").innerText = "Error happened when copying to clipboard. Here's the text to manually copy for yourself: " + text;
        }

        document.body.removeChild(textArea);
    }
</script>
</body>
</html>